@startuml ATM_StateChart
skinparam StateBackgroundColor LightBlue
skinparam StateBorderColor Blue

' Initial and Final states
[*] --> Idle

' Main states
state Idle {
    [*] --> WaitingForCard
}

state "Card Inserted" as CardInserted {
    [*] --> ValidatingCard
    ValidatingCard --> WaitingForPIN : Insert Card
}

state "PIN Validation" as PINValidation {
    [*] --> WaitingForPIN
    WaitingForPIN --> ValidatingPIN : Enter PIN
    ValidatingPIN --> TransactionSelection : Valid PIN
    ValidatingPIN --> RetryPIN : Invalid PIN
    RetryPIN --> WaitingForPIN : Retry PIN
    RetryPIN --> RetainCard : Max Retries Exceeded
}

state "Transaction Selection" as TransactionSelection {
    [*] --> SelectingTransaction
    SelectingTransaction --> ProcessingWithdrawal : Withdraw Cash
    SelectingTransaction --> ProcessingDeposit : Deposit Cash
    SelectingTransaction --> CheckingBalance : Check Balance
}

state "Processing Transaction" as ProcessingTransaction {
    state "Processing Withdrawal" as ProcessingWithdrawal {
        [*] --> EnteringAmount
        EnteringAmount --> ValidatingFunds : Enter Amount
        ValidatingFunds --> DispensingCash : Sufficient Funds
        ValidatingFunds --> InsufficientFunds : Insufficient Funds
        DispensingCash --> UpdatingAccount : Dispense Cash
        UpdatingAccount --> PrintingReceipt : Update Account Balance
    }

    state "Processing Deposit" as ProcessingDeposit {
        [*] --> AcceptingCash
        AcceptingCash --> UpdatingAccount : Insert Cash
        UpdatingAccount --> PrintingReceipt : Update Account Balance
    }

    state "Checking Balance" as CheckingBalance {
        [*] --> DisplayingBalance
        DisplayingBalance --> PrintingReceipt : Display Balance
    }

    PrintingReceipt --> TransactionComplete : Print Receipt
}

state "Transaction Complete" as TransactionComplete {
    [*] --> EjectingCard
    EjectingCard --> Idle : Eject Card
}

state "Error" as ErrorState {
    [*] --> DisplayingError
    DisplayingError --> Idle : Reset
}

' Transitions
Idle --> CardInserted : Insert Card
CardInserted --> PINValidation : Enter PIN
PINValidation --> TransactionSelection : Valid PIN
PINValidation --> ErrorState : Invalid PIN
TransactionSelection --> ProcessingTransaction : Select Transaction
ProcessingTransaction --> TransactionComplete : Transaction Processed
TransactionComplete --> Idle : Eject Card

' Notes
note right of PINValidation
  PIN validation is required
  before any transaction
end note

note right of ProcessingTransaction
  All transactions update
  the account balance and
  generate a receipt
end note

@enduml